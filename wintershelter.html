<style>
    .steps {
        display: none;
    }
</style>
<script>
/* Start of Help Popup Modular Script*/
$( document ).ready(function() {
	
	$("*[data-toggle=tooltip]").tooltip();
	
	$(".help_popup_a").click(function(event){
		event.preventDefault();
		$(".help_popup_description",$(this).parent()).toggle();
		if($(".help_popup_description",$(this).parent()).css("display")=="block") {
			$(this).html("Hide the help!");
		} else
			$(this).html("Get some help");
	});

});
/* End of Help Popup Modular Script*/
</script>
<div class="row skeleton"> 
    <div id="area0" class="col-xs-6">
        <!-- Questionary -->
		<!-- Step -1-->
        <div id="step_relevant_filter" class="steps">
            <h1>Is this photo spam or fake?</h1>
				<p>If this image is spam, advertising or fake select "Yes". If it looks legitimate, select "No".</p>
				<p>Selecting "Yes" will skip this photo</p>
				<p>Selecting "No" or "I don't know" will allow you to go ahead with the analysis</p>
				<p>If you are not sure, select "No" or "I don't know"</p>					
            <div id="answer"> <!-- Start DIV for the submission buttons -->
                <!-- If the user clicks this button, the saved answer will be value="yes"-->
                <button class="step_relevant_filter btn btn-danger btn-answer" value='Yes'><i class="fa fa-white fa-thumbs-up"></i> Yes</button>
                <!-- If the user clicks this button, the saved answer will be value="no"-->
                <button class="step_relevant_filter btn btn-success btn-answer" value='No'><i class="fa fa-white fa-thumbs-down"></i> No</button>
                <!-- If the user clicks this button, the saved answer will be value="NoPhoto"-->
                <button class="step_relevant_filter btn btn-answer" value='NoPhoto'><i class="fa fa-white fa-exclamation"></i> No photo</button>
                <!-- If the user clicks this button, the saved answer will be value="Unknown"-->
                <button class="step_relevant_filter btn btn-answer" value='Unknown'><i class="fa fa-white fa-question-sign"></i> I don't know</button>
            </div><!-- End of DIV for the submission buttons -->
        </div>
        <!-- End Step -1 -->
		
       <!-- Step 0-->
        <div id="step_0" class="steps">
            <h1>Do you see shelter in this photo?</h1>
			<div class="row help_popup col-xs-12">
			<i class="fa fa-exclamation-circle"></i> How do I answer this question? <a class="help_popup_a" href="javascript:void(0)">Get some help</a>
				<div class="help_popup_description col-xs-12">
					<p>This is a filtering question to remove any photos that do not have shelter in them and therefore are not relevant to this analysis.</p>
					<p>Click “Yes” is you see any shelter in the photo. </p>
					<p>Click “No” if you do not see any shelter. If you are unsure if something is shelter, "don't know" is a valid and useful answer.</p>
					</div>					
				</div>
			
            <div id="answer"> <!-- Start DIV for the submission buttons -->
                <!-- If the user clicks this button, the saved answer will be value="yes"-->
                <button class="step_0 btn btn-success btn-answer" value='Yes'><i class="fa fa-white fa-thumbs-up"></i> Yes</button>
                <!-- If the user clicks this button, the saved answer will be value="no"-->
                <button class="step_0 btn btn-danger btn-answer" value='No'><i class="fa fa-white fa-thumbs-down"></i> No</button>
                <!-- If the user clicks this button, the saved answer will be value="NoPhoto"-->
                <button class="step_0 btn btn-answer" value='NoPhoto'><i class="fa fa-white fa-exclamation"></i> No photo</button>
                <!-- If the user clicks this button, the saved answer will be value="Unknown"-->
                <button data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Did you read the Get Some Help section?" class="step_0 btn btn-answer" value='Unknown'><i class="fa fa-white fa-question-sign"></i> I don't know</button>
            </div><!-- End of DIV for the submission buttons -->
        </div>
        <!-- End Step 0 -->
		
		<!-- Step 1-->
        <div id="step_1" class="steps">
            <h1>Is the shelter raised off the ground?</h1>
			<div class="row help_popup col-xs-12">
			<i class="fa fa-exclamation-circle"></i> How do I answer this question? <a class="help_popup_a" href="javascript:void(0)">Get some help</a>
				<div class="help_popup_description col-xs-12">
					<p>This analysis is about whether shelter has a plinth underneath that raises it off the ground. This gives the shelter some protection against flooding.</p>
					<p>Click “Yes” if the shelter is raised from the ground, either by a wood or concrete layer or raised earth. </p>			
					<p>Click “No” if the shelter is clearly not raised off the ground. If you are unsure, "don't know" is the best answer.</p>
					</div>					
				</div>
			
            <div id="answer"> <!-- Start DIV for the submission buttons -->
                <!-- If the user clicks this button, the saved answer will be value="yes"-->
                <button class="step_1 btn btn-success btn-answer" value='Yes'><i class="fa fa-white fa-thumbs-up"></i> Yes</button>
                <!-- If the user clicks this button, the saved answer will be value="no"-->
                <button class="step_1 btn btn-danger btn-answer" value='No'><i class="fa fa-white fa-thumbs-down"></i> No</button>
                <!-- If the user clicks this button, the saved answer will be value="NoPhoto"-->
                <button class="step_1 btn btn-answer" value='NoPhoto'><i class="fa fa-white fa-exclamation"></i> No photo</button>
                <!-- If the user clicks this button, the saved answer will be value="Unknown"-->
                <button data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Did you read 'Get some help' above?" class="step_1 btn btn-answer" value='Unknown'><i class="fa fa-white fa-question-sign"></i>Don't know</button>
            </div><!-- End of DIV for the submission buttons -->
        </div>
        <!-- End Step 1 -->
		
		<!-- Step 2-->
        <div id="step_2" class="steps">
            <h1>Does the shelter have a second cover to protect it from the rain?</h1>
			<div class="row help_popup col-xs-12">
			<i class="fa fa-exclamation-circle"></i> How do I answer this question? <a class="help_popup_a" href="javascript:void(0)">Get some help</a>
				<div class="help_popup_description col-xs-12">
					<p>This analysis is about whether shelter has a second cover on top, called a fly sheet, which protects against rain or snow.</p>
					<p>Click “Yes” if you can see a second layer on top of the covering of the shelter. </p>			
					<p>Click “No” if the shelter appears to have only one layer. If you are unsure, "don't know" is the best answer.</p>
					</div>					
				</div>
			
            <div id="answer"> <!-- Start DIV for the submission buttons -->
                <!-- If the user clicks this button, the saved answer will be value="yes"-->
                <button class="step_2 btn btn-success btn-answer" value='Yes'><i class="fa fa-white fa-thumbs-up"></i> Yes</button>
                <!-- If the user clicks this button, the saved answer will be value="no"-->
                <button class="step_2 btn btn-danger btn-answer" value='No'><i class="fa fa-white fa-thumbs-down"></i> No</button>
                <!-- If the user clicks this button, the saved answer will be value="NoPhoto"-->
                <button class="step_2 btn btn-answer" value='NoPhoto'><i class="fa fa-white fa-exclamation"></i> No photo</button>
                <!-- If the user clicks this button, the saved answer will be value="Unknown"-->
                <button data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Did you read 'Get some help' above?" class="step_2 btn btn-answer" value='Unknown'><i class="fa fa-white fa-question-sign"></i>Don't know</button>
            </div><!-- End of DIV for the submission buttons -->
        </div>
        <!-- End Step 2 -->

		<!-- Step 3-->
        <div id="step_3" class="steps">
               <h1>Is there space to put a chimney safely inside the shelter?</h1>
			<div class="row help_popup col-xs-12">
			<i class="fa fa-exclamation-circle"></i> How do I answer this question? <a class="help_popup_a" href="javascript:void(0)">Get some help</a>
				<div class="help_popup_description col-xs-12">
					<p>To safely use a stove inside a shelter, there needs to be a chimney or space to put one without burning down the shelter or people inside inhaling smoke.
					<p>Click “Yes” if the shelter already has a chimney or if it has a metal plate to put a chimney pipe. </p>			
					<p>Click “No” if there would be no space to install a chimney safely. If you are unsure, "don't know" is the best answer.</p>
					</div>					
				</div>
			
            <div id="answer"> <!-- Start DIV for the submission buttons -->
                <!-- If the user clicks this button, the saved answer will be value="yes"-->
                <button class="step_3 btn btn-success btn-answer" value='Yes'><i class="fa fa-white fa-thumbs-up"></i> Yes</button>
                <!-- If the user clicks this button, the saved answer will be value="no"-->
                <button class="step_3 btn btn-danger btn-answer" value='No'><i class="fa fa-white fa-thumbs-down"></i> No</button>
                <!-- If the user clicks this button, the saved answer will be value="NoPhoto"-->
                <button class="step_3 btn btn-answer" value='NoPhoto'><i class="fa fa-white fa-exclamation"></i> No photo</button>
                <!-- If the user clicks this button, the saved answer will be value="Unknown"-->
                <button data-toggle="tooltip" data-placement="bottom" title="" data-original-title="Did you read 'Get some help' above?" class="step_3 btn btn-answer" value='Unknown'><i class="fa fa-white fa-question-sign"></i>Don't know</button>
            </div><!-- End of DIV for the submission buttons -->
        </div>
        <!-- End Step 3 -->	
		
        <!-- Last Step -->
        <div id="last_step" class="steps">
            <h1>Thanks! Your analysis is complete.</h1>
            <p> If you have feedback or would like to discuss this analysis, please <a href="https://github.com/geotagx/pybossa/issues">contribute to our open repository</a> or <a href="mailto:cobi.smith@unitar.org?Subject=GeoTag-X feedback" target="_top">send an email</a> if you prefer. </p>
             <div id="answer"> <!-- Start DIV for the submission buttons -->
                <!-- If the user clicks this button, the saved answer will be value="yes"-->
                <button class="last_step btn btn-answer btn-large btn-success" value='Submit'>Save it and load another one</button>
            </div><!-- End of DIV for the submission buttons -->
        </div>
        <!-- End Last Step-->
		
        <!-- End questionary -->
        <div style="margin-top:5px;">
            <button class="back btn btn-answer" style="display:none;"><i class="fa fa-chevron-left"></i> Go to previous step</button>
        </div>
    </div>
    <!--<div id="img-details" class="col-xs-4">-->
        <!-- Collapse -->
        <!--<div class="accordion" id="accordion2">
            <div class="accordion-group">
                <div class="accordion-heading">
                    <a class="accordion-toggle" data-toggle="collapse" data-parent="#accordion2" href="#collapseOne">
                       EXIF data 
                    </a>
                </div>
                <div id="collapseOne" class="accordion-body collapse in">
                    <div id="exif" class="accordion-inner">
                        This picture does not have any EXIF data.
                    </div>
                </div>
            </div>
        </div>-->
        <!-- End collapse -->
        <!--</div>-->

    <!-- +FC UNOSAT ZOOM MODIFICATION -->
    <div id="area1" class="col-xs-6 affix-top">
		<div class="row">
			<div class="col-xs-12" id="photo-link">
					<img id="photo" src="http://i.imgur.com/GeHxzb7.png" style="max-width=100%">
			</div>
			<div class="col-xs-12" style="margin-top:10px;">
					<a href="javascript:zoomin()" class="btn btn-primary">Zoom IN</a>
					&nbsp;|&nbsp;
					<a href="javascript:zoomout()"  class="btn btn-primary">Zoom OUT</a>
					&nbsp;|&nbsp;
					<a id="img_source" target="_blank" href="#"  class="btn btn-primary">View Photo Source</a>
			</div>
		</div>
    </div>
	<!-- -FC UNOSAT ZOOM MODIFICATION -->

</div><!-- End of Skeleton Row -->

<div class="row">
    <!-- Success and Error Messages for the user --> 
    <div class="col-xs-6 col-xs-offset-2" style="height:50px">
        <div id="success" class="alert alert-success" style="display:none;">
            <a class="close">×</a>
            <strong>Well done!</strong> Your answer has been saved
        </div>
        <div id="loading" class="alert alert-info" style="display:none;">
            <a class="close">×</a>
            Loading next task...
        </div>
        <div id="taskcompleted" class="alert alert-info" style="display:none;">
            <strong>The task has been completed!</strong> Thanks a lot!
        </div>
        <div id="finish" class="alert alert-success" style="display:none;">
            <strong>Congratulations!</strong> You have participated in all available tasks!
            <br/>
            <div class="alert-actions">
                <a class="btn small" href="/">Go back</a>
                <a class="btn small" href="/app">or, Check other applications</a>
            </div>
        </div>
        <div id="error" class="alert alert-error" style="display:none;">
            <a class="close">×</a>
            <strong>Error!</strong> Something went wrong, please contact the site administrators
        </div>
    </div> <!-- End Success and Error Messages for the user -->
</div> <!-- End of Row -->

<!-- +FC UNOSAT WORKFLOW/ZOOM MODIFICATION -->
<script src="/static/js/pybossa/unosat.js"></script>
<!-- -FC UNOSAT WORKFLOW/ZOOM MODIFICATION -->

<script>

function zoomin(){
    $("#photo-link").addClass("zoomed");

}

function zoomout() {
    $("#photo-link").removeClass("zoomed");
    
}
pybossa.taskLoaded(function(task, deferred) {
    if ( ! $.isEmptyObject(task) ) {
        // load image from flickr
        var img = $('<img />');
        img.load(function() {
            // continue as soon as the image is loaded
            deferred.resolve(task);
        });
        img.attr('src', task.info.url);
        img.attr('id', 'anno_' + task.id);
        img.addClass('img-polaroid');
        img.addClass('annotable');
        task.info.image = img;
        // Initiate answer with default values
        task.steps = [0];
        task.answer = {"img": task.info.url,
                       "task_id": task.id,
                       "shelter": "",
                       "shelterraised": "",
					   "shelterflysheet": "",
                       "shelterchimney": "",}
    }
    else {
        deferred.resolve(task);
    }
});

pybossa.presentTask(function(task, deferred) {
    if ( !$.isEmptyObject(task) ) {
        $('#photo-link').html('').append(task.info.image);
        //$("#question").html(task.info.question);
        $('#task-id').html(task.id);
        $("#img_source").attr("href", task.info.uri);
        $(".back").hide();

        // Hide all steps first 
        $(".steps").hide();
        // Show first step
        $("#step_relevant_filter").show();
        // Reset input fields
        //$("#n_stories").val(0);

        $('.btn-answer').off('click').on('click', function(evt) {
            // Get value of pressed button
            var tmp = $(evt.target).attr("value");
			
			// PAGINATION
          
			var pag_max_steps = $(".steps").length;
			var pag_n_steps = $(".steps").index($(".steps:visible"));
			var pag_perc=(((pag_n_steps+1)/(pag_max_steps-1))*100).toFixed(0);
			$("#progress_bar_task").css("width",pag_perc+"%");
			$("#progress_bar_task").html(pag_perc+"%");

			// PAGINATION
          
			// Check if step is the photo filter
            if ($(evt.target).hasClass('step_relevant_filter')) {
                
                $(".steps").hide();
                if (tmp == "No") {
                    //alert("DB: Yes");
                    $("#step_0").show();
                    
                    }
                else {
					alert("DB: No ajax");
					$.ajax({
						url: url + 'api/filter/' + taskid +'/no',
						dataType: 'json'
					});
                    $("#last_step").show();
                }
            } 
			
            // Check if step is 0
            if ($(evt.target).hasClass('step_0')) {
                task.answer.shelter = tmp;
                $(".steps").hide();
                if (tmp == "Yes") {
                    task.steps.push(1);
                    $("#step_1").show();
                    $(".back").show();
                    }
                else {
                    $("#last_step").show();
                }
            } 
             // Check if step is 1
            if ($(evt.target).hasClass('step_1')) {
                task.answer.shelterraised = tmp;
                $(".steps").hide();
                task.steps.push(2);
                $("#step_2").show();
            } 

              // Check if step is 2
            if ($(evt.target).hasClass('step_2')) {
                task.answer.shelterflysheet = tmp;
                $(".steps").hide();
                task.steps.push(3);
                $("#step_3").show();               
            }

			  // Check if step is 3
            if ($(evt.target).hasClass('step_3')) {
                  task.answer.shelterchimney = tmp;
                $(".steps").hide();
                $("#last_step").show();              
            }
			
            // Check if step is last
            if ($(evt.target).hasClass('last_step')) {
                zoomout();
				$(".help_popup_description").css("display","none");
                $("input:checkbox").removeAttr("checked");
                //+FC UNOSAT WORKFLOW MODIFICATION
                saveTask(task.id, task.answer).done(function() {
                deferred.resolve();
                })
                //-FC UNOSAT WORKFLOW MODIFICATION
            }

            // Check if back button is pressed
            if ($(evt.target).hasClass('back')) {
                console.log(JSON.stringify(task.steps));
                zoomout();
                $("#last_step").hide();
                var last_step = task.steps.pop();
                var id = "#step_" + last_step.toString();
                var prev_id = "#step_" + task.steps[task.steps.length - 1];
                $(id).hide();
                $(prev_id).show();
                if (prev_id == "#step_0") {
                    $(".back").hide();
                    task.steps = [0];
                }

                //if ((prev_id == "#step_9") || (prev_id == "#step_11") || (prev_id == '#step_14') || (prev_id == '#step_15')) {
                //    anno.reset();
                //    $("#crack_category").hide();
                //    $("#crack_rebars").hide();
                //    $("#crack_rebars").hide();
                //    $("#damage_category").hide();
                //    $("#answer").hide();
                //}

                console.log(JSON.stringify(task.steps));
            }
            // print answer on console
            // console.log(JSON.stringify(task.answer));
        });


        //$("#btn-submit").html("<i class='fa-repeat'></i> I don't recognize any person, try next one");
        //$("#btn-submit").removeClass("btn-success");
        //if (!$.isEmptyObject(task.info.exif)) {
        //    //var keys = Object.keys(task.info.exif);
        //    //$("#exif").html("");
        //    //for(i=0;i<keys.length;i++){
        //    //$("#exif").append("<p><strong>" + keys[i] + "</strong>: " + task.info.exif[keys[i]] + "</p>");
        //    //}
        //    $("#exif").html(JSON.stringify(task.info.exif));
        //}
        //else {
        //    $("#exif").html("There is no EXIF data in this picture.");
        //}

        //anno.makeAnnotatable(document.getElementById('anno_' + task.id));

        //anno.addHandler('onAnnotationCreated', function(annotation) {
        //    //console.log(annotation.text);
        //    $("#btn-submit").html("<i class='fa fa-save'></i> Save current annotations");
        //    $("#btn-submit").addClass("btn-success");
        //});

        //$('.btn-answer').off('click').on('click', function(evt) {
        //    var answer = $(evt.target).attr("value");
        //    if (typeof answer != 'undefined') {
        //        //console.log(answer);
        //        pybossa.saveTask(task.id, anno.getAnnotations()).done(function() {
        //            deferred.resolve();
        //        });
        //        $("#loading").fadeIn(500);
        //        if ($("#disqus_thread").is(":visible")) {
        //            $('#disqus_thread').toggle();
        //            $('.btn-disqus').toggle();
        //        }
        //    }
        //    else {
        //        $("#error").show();
        //    }
        //});
        $("#loading").hide();
    }
    else {
        $(".skeleton").hide();
        $("#loading").hide();
        $("#finish").fadeIn(500);
    }
});




//+FC UNOSAT WORKFLOW MODIFICATION
make_run('wintershelter','wintershelter');
//-FC UNOSAT WORKFLOW MODIFICATION

</script>
